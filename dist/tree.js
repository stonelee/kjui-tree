define("kjui/tree/1.1.0/tree",["$","kjui/grid/1.3.0/grid","arale/widget/1.0.4/widget","arale/base/1.0.1/base","arale/class/1.0.0/class","arale/events/1.0.0/events","arale/widget/1.0.4/templatable","gallery/handlebars/1.0.1/handlebars","gallery/underscore/1.4.2/underscore"],function(e,t,n){var r=e("$"),i=e("kjui/grid/1.3.0/grid"),s=e("gallery/handlebars/1.0.1/handlebars"),o=e("gallery/underscore/1.4.2/underscore"),u='<tr class="grid-row" data-id="{{id}}" {{#if expanded}}data-status="expanded"{{/if}} {{#if leaf}}data-role="leaf"{{else}}data-role="expander"{{/if}}> <td class="grid-cell"> {{#each icons}}<i class="icon-tree-{{this}}"></i>{{/each}}<span data-role="text" style="cursor:pointer;" class="unselectable">{{name}}</span> </td> {{#each grids}} <td class="grid-cell"{{#if align}} style="text-align:{{align}};"{{/if}}> {{{value}}} </td> {{/each}} </tr>',a=i.extend({model:{paginate:!1,showRoot:!0,children:"children",multiSelect:!1,cascade:!1},setup:function(){this.$(".grid-view table").addClass("grid-no-border"),a.superclass.setup.call(this)},_loadData:function(e){this.data=e,this._tree=this.$(".grid-no-border tbody"),this.model.showRoot?(this._createRow(["elbow-end-minus","folder"],e),this._loopRow(e,["elbow-empty"])):this._loopRow(e,[]),this._processData(),this.$(".grid-row").each(function(e,t){var n=r(t),i=n.data("data").icon;i&&n.find(".icon-tree-leaf,.icon-tree-folder").css("background",'url("'+i+'") no-repeat 0 0')}),this.model.multiSelect?(this.$(".icon-tree-leaf,.icon-tree-folder").before(r('<input type="checkbox" data-role="check">')),this.selected=[]):this.selected=null,this.trigger("loaded")},_loopRow:function(e,t){var n=this.model.children,r=e[n];for(var i=0;i<r.length;i++){var s=r[i];s[n].length===0?i!=r.length-1?this._createRow(t.concat("elbow","leaf"),s):this._createRow(t.concat("elbow-end","leaf"),s):(i!=r.length-1?this._createRow(t.concat("elbow-minus","folder"),s):this._createRow(t.concat("elbow-end-minus","folder"),s),i!=r.length-1?this._loopRow(s,t.concat("elbow-line")):this._loopRow(s,t.concat("elbow-empty")))}},_createRow:function(e,t){var n=[];this.model.fields&&(n=r.map(this.model.fields,function(e){if(e.name){var n=t[e.name];n=o.escape(n),r.isFunction(e.render)&&(n=e.render(n));var i=o.clone(e);return i.value=n,i}}));var i=t[this.model.children],a=s.compile(u)({id:t.id,icons:e,name:t.name,expanded:i.length!==0?!0:!1,leaf:i.length===0?!0:!1,grids:n}),f=r(a);f.data("data",t),this._tree.append(f)},_processData:function(){var e=this,t=this.model.children;this.$(".grid-row").each(function(n,i){var s=r(i),o=s.data("data")[t];r.each(o,function(t,n){var r=e.$(".grid-row[data-id="+n.id+"]");r.data("parent",s),r.data("siblings",e._getSiblings(n.id,o))});var u=[];e._getChildren(s.data("data"),u),s.data("children",u)}),this.$(".grid-row").each(function(n,i){var s=r(i);s.data("parent")||s.data("siblings",e._getSiblings(s.data("data").id,e.data[t]))})},_getChildren:function(e,t){var n=this,i=this.model.children;r.each(e[i],function(e,r){var s=n.$(".grid-row[data-id="+r.id+"]");t.push(s),r[i].length>0&&n._getChildren(r,t)})},_getSiblings:function(e,t){var n=this,i=[];return r.each(t,function(t,r){r.id!==e&&i.push(n.$(".grid-row[data-id="+r.id+"]"))}),i},events:{"click [class$=-minus],[class$=-plus]":"_toggle","dblclick  [data-role=expander] [data-role=text]":"_toggle","click .grid-row":"_click","click [data-role=check]":"_check"},_toggle:function(e){var t=r(e.target),n=t.parents("tr");n.attr("data-status")=="expanded"?this.shrink(n):this.expand(n)},expand:function(e){this._show(e),this._changeIcon(e,"plus","minus"),e.attr("data-status","expanded")},shrink:function(e){this._hide(e),this._changeIcon(e,"minus","plus"),e.removeAttr("data-status")},_changeIcon:function(e,t,n){var r=e.find("[class$=-"+t+"]"),i=r.attr("class");i=i.replace(t,n),r.attr("class",i)},_show:function(e){var t=this;r.each(e.data("data")[this.model.children],function(e,n){var r=t.$(".grid-row[data-id="+n.id+"]");r.show(),r.attr("data-status")=="expanded"&&t._show(r)})},_hide:function(e){var t=this;r.each(e.data("data")[this.model.children],function(e,n){var r=t.$(".grid-row[data-id="+n.id+"]");r.hide(),r.attr("data-role")=="expander"&&r.attr("data-status")=="expanded"&&t._hide(r)})},_click:function(e){var t=r(e.target),n=t.parents("tr"),i=n.data("data");/minus|plus/.test(t.attr("class"))||(this.model.multiSelect||(this.selected&&this.selected.data("data").id===i.id?(this.selected=null,n.removeClass("grid-row-is-selected")):(this.selected=n,n.addClass("grid-row-is-selected").siblings().removeClass("grid-row-is-selected"))),t.attr("data-role")!="check"&&this.trigger("click",t,i))},_check:function(e){var t=this,n=r(e.target),i=n.parents("tr");n.prop("checked")?(this._checkRow(i),this.model.cascade&&r.each(i.data("children"),function(e,n){t.check(n)})):(this._unCheckRow(i),this.model.cascade&&r.each(i.data("children"),function(e,n){t.unCheck(n)}))},_checkRow:function(e){this.selected.push(e),e.addClass("grid-row-is-selected")},_unCheckRow:function(e){var t=e.data("data").id;for(var n=this.selected.length-1;n>=0;n--)this.selected[n].data("data").id===t&&this.selected.splice(n,1);e.removeClass("grid-row-is-selected")},check:function(e){var t=e.find("[data-role=check]");if(!t)return;t.prop("checked")||(this._checkRow(e),t.prop("checked",!0))},unCheck:function(e){var t=e.find("[data-role=check]");if(!t)return;t.prop("checked")&&(this._unCheckRow(e),t.prop("checked",!1))},select:function(e){if(this.model.multiSelect)return;var t=e.data("parent");while(t)t.attr("data-status")!="expanded"&&this.expand(t),t=t.data("parent");this.selected=e,e.addClass("grid-row-is-selected").siblings().removeClass("grid-row-is-selected");var n=e.parent().children(":visible").index(e);this.$(".grid-view").scrollTop(e.height()*n);var r=e.data("data");this.trigger("click",e,r)},refresh:function(){var e=this.get("url");this._onRenderUrl(e)}});n.exports=a});