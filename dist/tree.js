define("kjui/tree/1.0.0/tree",["$","arale/widget/1.0.2/widget","arale/base/1.0.1/base","arale/class/1.0.0/class","arale/events/1.0.0/events","gallery/handlebars/1.0.0/handlebars","gallery/underscore/1.4.2/underscore"],function(e,t,n){var r=e("$"),i=e("arale/widget/1.0.2/widget"),s=e("gallery/handlebars/1.0.0/handlebars"),o=e("gallery/underscore/1.4.2/underscore"),u='<div class="mod" style="width:{{width}}px;"> {{#if title}} <div class="hd unselectable"> <span class="hd-title">{{title}}</span> </div> {{/if}} <div class="bd">{{#if fields}} <div class="grid-hd unselectable"> <table><thead><tr> {{#each fields}} <th class="grid-cell" width="{{width}}"> <span>{{header}}</span> </th> {{/each}} </tr></thead></table> </div> {{/if}}<div class="grid-bd"{{#if height}} style="height:{{height}}px"{{/if}}> <table class="grid-no-border"><tbody></tbody></table> </div></div> </div>',a='<tr class="grid-row" data-id="{{id}}" {{#if expanded}}data-status="expanded"{{/if}} {{#if leaf}}data-role="leaf"{{else}}data-role="expander"{{/if}}> <td class="grid-cell"{{#if treeColumnWidth}} width="{{treeColumnWidth}}"{{/if}}> {{#each icons}}<i class="icon icon-tree-{{this}}"></i>{{/each}}<span data-role="text" style="cursor:pointer;" class="unselectable">{{name}}</span> </td> {{#each grids}} <td class="grid-cell" width="{{width}}"{{#if align}} style="text-align:{{align}};"{{/if}}> {{{value}}} </td> {{/each}} </tr>',f=i.extend({attrs:{url:"",data:[],title:"",fields:[],children:"children",multiSelect:!1,cascade:!1,width:0,height:0},_onRenderUrl:function(e){var t=this;r.getJSON(e,function(e){t._createTree(e.data)})},_onRenderData:function(e){this._createTree(e)},_createTree:function(e){this.data=e;var t=this.get("width")||this.element.parent().width(),n=this._processField(t),i=this.get("height"),o=s.compile(u)({width:t,height:i,title:this.get("title"),fields:n});this.element.html(o),this._tree=this.$(".grid-no-border tbody"),this._createRow(["elbow-end-minus","folder"],e),this._loopRow(e,["elbow-empty"]),this._processData(),this.$(".grid-row").each(function(e,t){var n=r(t),i=n.data("data").icon;i&&n.find(".icon-tree-leaf,.icon-tree-folder").css("background",'url("'+i+'")')}),this.get("multiSelect")?(this.$(".icon-tree-leaf,.icon-tree-folder").before(r('<input type="checkbox" data-role="check">')),this.selected=[]):this.selected=null,i||(i=this.element.height()-this.$(".grid-bd").position().top-1,this.$(".grid-bd").height(i)),this.trigger("rendered",this)},_processField:function(e){var t=this.get("fields");if(!t)return[];var n=0,i=0;r.each(t,function(){this.width&&(n+=this.width,i+=1)});var s=e-t.length*9-n-18,o=s/(t.length-i);return t=r.map(t,function(e){return e.width||(e.width=o),e}),this._fields=t,t},_loopRow:function(e,t){var n=this.get("children"),r=e[n];for(var i=0;i<r.length;i++){var s=r[i];s[n].length===0?i!=r.length-1?this._createRow(t.concat("elbow","leaf"),s):this._createRow(t.concat("elbow-end","leaf"),s):(i!=r.length-1?this._createRow(t.concat("elbow-minus","folder"),s):this._createRow(t.concat("elbow-end-minus","folder"),s),i!=r.length-1?this._loopRow(s,t.concat("elbow-line")):this._loopRow(s,t.concat("elbow-empty")))}},_createRow:function(e,t){var n=[],i=0;this._fields&&(n=r.map(this._fields,function(e){if(e.name){var n=t[e.name];return n=o.escape(n),r.isFunction(e.render)&&(n=e.render(n)),e.value=n,e}e.width&&(i=e.width)}));var u=t[this.get("children")],f=s.compile(a)({id:t.id,treeColumnWidth:i,icons:e,name:t.name,expanded:u.length!==0?!0:!1,leaf:u.length===0?!0:!1,grids:n}),l=r(f);l.data("data",t),this._tree.append(l)},_processData:function(){var e=this,t=this.get("children");this.$(".grid-row").each(function(n,i){var s=r(i),o=s.data("data")[t];r.each(o,function(t,n){var r=e.$(".grid-row[data-id="+n.id+"]");r.data("parent",s),r.data("siblings",e._getSiblings(n.id,o))});var u=[];e._getChildren(s.data("data"),u),s.data("children",u)}),this.$(".grid-row").each(function(n,i){var s=r(i);s.data("parent")||s.data("siblings",e._getSiblings(s.data("data").id,e.data[t]))})},_getChildren:function(e,t){var n=this,i=this.get("children");r.each(e[i],function(e,r){var s=n.$(".grid-row[data-id="+r.id+"]");t.push(s),r[i].length>0&&n._getChildren(r,t)})},_getSiblings:function(e,t){var n=this,i=[];return r.each(t,function(t,r){r.id!==e&&i.push(n.$(".grid-row[data-id="+r.id+"]"))}),i},events:{"click [class$=-minus],[class$=-plus]":"_toggle","dblclick  [data-role=expander] [data-role=text]":"_toggle","click .grid-row":"_click","click [data-role=check]":"_check"},_toggle:function(e){var t=r(e.target),n=t.parents("tr");n.attr("data-status")=="expanded"?this.shrink(n):this.expand(n)},expand:function(e){this._show(e),this._changeIcon(e,"plus","minus"),e.attr("data-status","expanded")},shrink:function(e){this._hide(e),this._changeIcon(e,"minus","plus"),e.removeAttr("data-status")},_changeIcon:function(e,t,n){var r=e.find("[class$=-"+t+"]"),i=r.attr("class");i=i.replace(t,n),r.attr("class",i)},_show:function(e){var t=this;r.each(e.data("data")[this.get("children")],function(e,n){var r=t.$(".grid-row[data-id="+n.id+"]");r.show(),r.attr("data-status")=="expanded"&&t._show(r)})},_hide:function(e){var t=this;r.each(e.data("data")[this.get("children")],function(e,n){var r=t.$(".grid-row[data-id="+n.id+"]");r.hide(),r.attr("data-role")=="expander"&&r.attr("data-status")=="expanded"&&t._hide(r)})},_click:function(e){var t=r(e.target),n=t.parents("tr"),i=n.data("data");/minus|plus/.test(t.attr("class"))||(this.get("multiSelect")||(this.selected&&this.selected.data("data").id===i.id?(this.selected=null,n.removeClass("grid-row-is-selected")):(this.selected=n,n.addClass("grid-row-is-selected").siblings().removeClass("grid-row-is-selected"))),t.attr("data-role")!="check"&&this.trigger("click",t,i))},_check:function(e){var t=this,n=r(e.target),i=n.parents("tr");n.prop("checked")?(this._checkRow(i),this.get("cascade")&&r.each(i.data("children"),function(e,n){t.check(n)})):(this._unCheckRow(i),this.get("cascade")&&r.each(i.data("children"),function(e,n){t.unCheck(n)}))},_checkRow:function(e){this.selected.push(e),e.addClass("grid-row-is-selected")},_unCheckRow:function(e){var t=e.data("data").id;for(var n=this.selected.length-1;n>=0;n--)this.selected[n].data("data").id===t&&this.selected.splice(n,1);e.removeClass("grid-row-is-selected")},check:function(e){var t=e.find("[data-role=check]");if(!t)return;t.prop("checked")||(this._checkRow(e),t.prop("checked",!0))},unCheck:function(e){var t=e.find("[data-role=check]");if(!t)return;t.prop("checked")&&(this._unCheckRow(e),t.prop("checked",!1))},select:function(e){if(this.get("multiSelect"))return;var t=e.data("parent");while(t)t.attr("data-status")!="expanded"&&this.expand(t),t=t.data("parent");this.selected=e,e.addClass("grid-row-is-selected").siblings().removeClass("grid-row-is-selected");var n=e.parent().children(":visible").index(e);this.$(".grid-bd").scrollTop(e.height()*n);var r=e.data("data");this.trigger("click",e,r)},refresh:function(){var e=this.get("url");this._onRenderUrl(e)}});n.exports=f});